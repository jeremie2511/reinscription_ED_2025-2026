<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réinscription - Espérance Drouaise</title>
    
    <!-- ======================= CSS INTÉGRÉ ======================= -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root { /* Variables de couleurs */
            --primary-color: #005a9c; --secondary-color: #28a745; --light-grey: #f4f7f6;
            --dark-grey: #555; --border-color: #ddd; --bg-color: #ffffff;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light-grey); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .form-container { max-width: 600px; width: 100%; background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); overflow: hidden; }
        header { text-align: center; margin-bottom: 25px; }
        .logo { max-width: 80px; margin-bottom: 10px; }
        h2 { color: var(--primary-color); margin: 0; }
        h3 { text-align: center; color: #333; margin-bottom: 25px; }
        h4 { margin-top: 20px; margin-bottom: 10px; color: var(--primary-color); border-bottom: 2px solid var(--light-grey); padding-bottom: 5px; }
        .progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 30px; height: 10px; margin-bottom: 30px; }
        .progress-bar-fill { height: 100%; background-color: var(--secondary-color); border-radius: 30px; width: 0%; transition: width 0.4s ease-in-out; }
        #inscriptionForm { position: relative; min-height: 400px; }
        .form-step { display: none; } /* On utilise display none pour une gestion plus simple */
        .form-step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 1rem; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--dark-grey); }
        .radio-card-group { display: flex; gap: 15px; }
        .radio-card { flex: 1; background: #f9f9f9; border: 2px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .radio-card input[type="radio"] { display: none; }
        .radio-card:has(input:checked) { border-color: var(--secondary-color); box-shadow: 0 0 10px rgba(40, 167, 69, 0.2); }
        .radio-card input[type="radio"]:checked + span { color: var(--secondary-color); font-weight: 600; }
        .radio-group-vertical label { display: block; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); cursor: pointer; }
        .checkbox-group { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .btn-next, #submitBtn { background-color: var(--secondary-color); color: white; }
        .btn-prev { background-color: #ccc; }
        .file-upload-wrapper { margin-top: 15px; text-align: center; }
        .file-upload-wrapper input[type="file"] { display: none; }
        .file-upload-wrapper .btn { display: inline-block; background-color: #6c757d; color: white; margin: 5px; font-size: 0.9rem; padding: 10px 15px; }
        .file-upload-wrapper span { display: block; margin-top: 10px; color: var(--dark-grey); font-style: italic; }
        .hidden { display: none !important; }
        .warning { background-color: #fff3cd; color: #856404; padding: 15px; border: 1px solid #ffeeba; border-radius: 5px; margin: 15px 0; }
        #loading, #successMessage, #errorMessage { text-align: center; padding: 40px 20px; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .child-info-group { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #fafafa; }
        .health-pdf-links a { display: block; text-align: center; padding: 10px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 8px; margin-bottom: 10px; }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #camera-modal video, #camera-modal canvas { max-width: 90%; max-height: 70vh; }
        #camera-modal .camera-buttons { margin-top: 20px; }
        #camera-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 330px; border: 4px dashed rgba(255, 255, 255, 0.7); border-radius: 50% / 40%; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); pointer-events: none; }
    </style>
</head>
<body>
    <div class="form-container">
        <header>
            <img src="https://i.imgur.com/lnozkwr.png" alt="Logo Espérance Drouaise" class="logo">
            <h2>Réinscription Saison 2025-2026</h2>
        </header>
        <div class="progress-bar"><div class="progress-bar-fill" id="progressBar"></div></div>
        <input type="file" id="photo-file-input" class="hidden" accept="image/*">
        <form id="inscriptionForm">
            <div class="form-step active" data-step="1">
                <h3>Pour qui est cette réinscription ?</h3>
                <div class="radio-card-group">
                    <label class="radio-card"><input type="radio" name="typeAdherent" value="mineur" required><span>Un ou plusieurs mineurs</span></label>
                    <label class="radio-card"><input type="radio" name="typeAdherent" value="majeur" required><span>Un adhérent majeur</span></label>
                </div>
                <div id="cotisation-mineur-select" class="hidden">
                    <p>Combien d'enfants de la famille inscrivez-vous ?</p>
                    <select id="numEnfants" name="numEnfants">
                        <option value="1">1 enfant</option><option value="2">2 enfants</option>
                        <option value="3">3 enfants</option><option value="4">4+ enfants</option>
                    </select>
                </div>
                <button type="button" class="btn btn-next">Suivant</button>
            </div>
            <div class="form-step" data-step="2">
                <h3>Informations personnelles</h3>
                <div id="section-responsable" class="hidden">
                    <h4>Responsable Légal</h4>
                    <input type="text" name="nomResponsable" placeholder="Nom & Prénom du responsable">
                    <input type="email" name="emailResponsable" placeholder="Email (pour la confirmation)">
                    <input type="tel" name="telephoneResponsable" placeholder="Téléphone">
                    <input type="text" name="adresseResponsable" placeholder="Adresse postale">
                    <input type="text" name="codePostalResponsable" placeholder="Code Postal">
                    <input type="text" name="villeResponsable" placeholder="Ville">
                </div>
                <div id="adherent-info-container"></div>
                <div class="nav-buttons"><button type="button" class="btn btn-prev">Précédent</button><button type="button" class="btn btn-next">Suivant</button></div>
            </div>
            <div class="form-step" data-step="3">
                <h3>Dossier de Santé</h3>
                <div class="health-pdf-links">
                    <a href="https://drive.google.com/file/d/1dD8kER0IXqTzQwUT9EEfKdsBb13-Qv9p/view?usp=share_link" target="_blank" rel="noopener noreferrer">Consulter le questionnaire MINEUR</a>
                    <a href="https://drive.google.com/file/d/1g343Xgj3jVNfLD31uHyXyT-l2a048RwS/view?usp=sharing" target="_blank" rel="noopener noreferrer">Consulter le questionnaire MAJEUR</a>
                </div>
                <div class="radio-group-vertical" style="margin-top:20px;">
                    <label><input type="radio" name="reponseQuestionnaire" value="non" required> J'atteste avoir répondu "NON" à toutes les questions.</label>
                    <small id="email-signature-info" class="hidden" style="display:block;margin-top:-5px;margin-bottom:10px;padding-left:15px;color:#555;">Un e-mail vous sera envoyé pour signer électroniquement cette attestation.</small>
                    <label><input type="radio" name="reponseQuestionnaire" value="oui" required> J'ai répondu "OUI" à au moins une question (certificat médical requis).</label>
                </div>
                <div id="certificat-medical-container" class="hidden file-upload-wrapper">
                    <p class="warning">Veuillez joindre un certificat médical.</p>
                    <label for="certificatMedical" class="btn">Téléverser le(s) certificat(s)</label>
                    <input type="file" id="certificatMedical" name="certificatMedical" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                    <span id="certificat-file-name">Aucun fichier choisi</span>
                </div>
                <div class="nav-buttons"><button type="button" class="btn btn-prev">Précédent</button><button type="button" class="btn btn-next">Suivant</button></div>
            </div>
            <div class="form-step" data-step="4">
                <h3>Finalisation</h3>
                 <div id="section-cotisation">
                     <h4>Cotisation</h4>
                     <p>Montant total pour la saison : <strong id="montantTotal">130 €</strong></p>
                </div>
                <div class="checkbox-group"><input type="checkbox" id="droitImage" name="droitImage" required><label for="droitImage">J'autorise la prise de vue et la diffusion de mon image (ou celle de mon/mes enfant(s)).</label></div>
                <div class="checkbox-group"><input type="checkbox" id="reglement" name="reglement" required><label for="reglement">J'ai lu et j'accepte le <a href="https://drive.google.com/file/d/1sBCrjrDXDr-Qh1mcUJ71ytZFIiTt5xvi/view?usp=sharing" target="_blank" rel="noopener noreferrer">règlement intérieur</a>.</label></div>
                <div class="nav-buttons"><button type="button" class="btn btn-prev">Précédent</button><button type="submit" id="submitBtn" class="btn">Envoyer</button></div>
            </div>
        </form>
        <div id="loading" class="hidden"> ... </div>
        <div id="successMessage" class="hidden"> ... </div>
        <div id="errorMessage" class="hidden"> ... </div>
    </div>
    <div id="camera-modal" class="hidden"> ... </div>
    
    <!-- ======================= JAVASCRIPT FINAL ET DÉFINITIF ======================= -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzoDe8VcbxozPLjZTDsh8qs83P-ch6fMmKKz4L01qfy9adk6fjVBWp6boyGWQab7kMVTA/exec';
            
            // --- Déclaration des constantes du formulaire ---
            const form = document.getElementById('inscriptionForm');
            const steps = Array.from(document.querySelectorAll('.form-step'));
            const nextBtns = document.querySelectorAll('.btn-next');
            const prevBtns = document.querySelectorAll('.btn-prev');
            const progressBar = document.getElementById('progressBar');
            const sectionResponsable = document.getElementById('section-responsable');
            const typeAdherentRadios = document.querySelectorAll('input[name="typeAdherent"]');
            const adherentInfoContainer = document.getElementById('adherent-info-container');
            const numEnfantsSelect = document.getElementById('numEnfants');
            const cotisationMineurSelect = document.getElementById('cotisation-mineur-select');
            
            let currentStep = 1;
            let photoFilesMap = new Map();
            
            // --- NOUVEAU : Références caméra déclarées ici ---
            const cameraModal = document.getElementById('camera-modal');
            const videoElement = document.querySelector('#camera-modal video');
            const canvasElement = document.querySelector('#camera-modal canvas');
            const captureBtn = document.querySelector('#camera-modal #capture-btn');
            const recaptureBtn = document.querySelector('#camera-modal #recapture-btn');
            const confirmBtn = document.querySelector('#camera-modal #confirm-photo-btn');
            const cancelBtn = document.querySelector('#camera-modal #cancel-camera-btn');
            const hiddenPhotoInput = document.getElementById('photo-file-input');
            let currentlyActiveChildIndex = null;
            let activeStream = null;

            // --- GESTION DE LA NAVIGATION ---
            nextBtns.forEach(btn => btn.addEventListener('click', () => { if (validateStep(currentStep)) changeStep(1); }));
            prevBtns.forEach(btn => btn.addEventListener('click', () => changeStep(-1)));

            function changeStep(direction) {
                steps[currentStep - 1].classList.remove('active');
                currentStep += direction;
                steps[currentStep - 1].classList.add('active');
                updateProgressBar();
            }

            function updateProgressBar() { progressBar.style.width = `${((currentStep - 1) / (steps.length - 1)) * 100}%`; }

            // --- FONCTION DE VALIDATION ---
            function validateStep(step) {
                const stepElement = document.querySelector(`.form-step[data-step="${step}"]`);
                if (!stepElement.checkValidity()) {
                    const firstInvalidField = stepElement.querySelector(':invalid');
                    if (firstInvalidField) {
                        alert(`Veuillez remplir correctement le champ : "${firstInvalidField.placeholder || firstInvalidField.labels[0]?.textContent || firstInvalidField.name}"`);
                        firstInvalidField.focus();
                    } else {
                        alert('Veuillez faire un choix pour continuer.');
                    }
                    return false;
                }
                 if (step === 2) {
                    const adherentCount = getAdherentCount();
                    if (photoFilesMap.size < adherentCount) {
                        alert(`Veuillez fournir une photo pour chaque adhérent (${photoFilesMap.size}/${adherentCount}).`); return false;
                    }
                }
                return true;
            }

            // --- GESTION DYNAMIQUE DES CHAMPS ---
            typeAdherentRadios.forEach(radio => radio.addEventListener('change', (e) => {
                const type = e.target.value;
                const respInputs = sectionResponsable.querySelectorAll('input');
                if (type === 'mineur') {
                    cotisationMineurSelect.classList.remove('hidden');
                    sectionResponsable.classList.remove('hidden');
                    respInputs.forEach(i => i.required = true);
                    numEnfantsSelect.required = true;
                    generateAdherentFields(parseInt(numEnfantsSelect.value));
                } else {
                    cotisationMineurSelect.classList.add('hidden');
                    sectionResponsable.classList.add('hidden');
                    respInputs.forEach(i => i.required = false);
                    numEnfantsSelect.required = false;
                    generateAdherentFields(1);
                }
                updateCotisation();
            }));

            numEnfantsSelect.addEventListener('change', () => {
                updateCotisation();
                generateAdherentFields(parseInt(numEnfantsSelect.value));
            });

            // --- GESTION DES PHOTOS ET DE LA CAMÉRA ---
            adherentInfoContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('choose-photo-btn')) {
                    currentlyActiveChildIndex = target.dataset.childIndex;
                    hiddenPhotoInput.click();
                }
                if (target.classList.contains('take-photo-btn')) {
                    currentlyActiveChildIndex = target.dataset.childIndex;
                    openCamera();
                }
            });

            hiddenPhotoInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0 && currentlyActiveChildIndex) {
                    photoFilesMap.set(currentlyActiveChildIndex, e.target.files[0]);
                    updatePhotoFileName(currentlyActiveChildIndex, e.target.files[0].name);
                }
                hiddenPhotoInput.value = '';
            });

            async function openCamera() {
                try {
                    activeStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    videoElement.srcObject = activeStream;
                    cameraModal.classList.remove('hidden');
                    videoElement.classList.remove('hidden');
                    canvasElement.classList.add('hidden');
                    captureBtn.classList.remove('hidden');
                    recaptureBtn.classList.add('hidden');
                    confirmBtn.classList.add('hidden');
                } catch (err) {
                    console.error("Erreur d'accès à la caméra : ", err);
                    alert("Impossible d'accéder à la caméra. Veuillez vérifier les autorisations de votre navigateur et qu'aucune autre application ne l'utilise.");
                }
            }

            function stopCamera() {
                if (activeStream) {
                    activeStream.getTracks().forEach(track => track.stop());
                    activeStream = null;
                }
                cameraModal.classList.add('hidden');
            }
            
            captureBtn.addEventListener('click', () => {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                canvasElement.getContext('2d').drawImage(videoElement, 0, 0);
                videoElement.classList.add('hidden');
                canvasElement.classList.remove('hidden');
                captureBtn.classList.add('hidden');
                recaptureBtn.classList.remove('hidden');
                confirmBtn.classList.remove('hidden');
            });
            
            recaptureBtn.addEventListener('click', () => {
                videoElement.classList.remove('hidden');
                canvasElement.classList.add('hidden');
                captureBtn.classList.remove('hidden');
                recaptureBtn.classList.add('hidden');
                confirmBtn.classList.add('hidden');
            });

            confirmBtn.addEventListener('click', () => {
                canvasElement.toBlob(blob => {
                    const newFile = new File([blob], `photo_cam_${currentlyActiveChildIndex}.jpg`, { type: 'image/jpeg' });
                    photoFilesMap.set(currentlyActiveChildIndex, newFile);
                    updatePhotoFileName(currentlyActiveChildIndex, newFile.name);
                    stopCamera();
                }, 'image/jpeg');
            });

            cancelBtn.addEventListener('click', stopCamera);

            function updatePhotoFileName(childIndex, fileName) {
                const span = document.getElementById(`photo-file-name-${childIndex}`);
                if (span) {
                    span.textContent = fileName;
                    span.style.color = '#28a745';
                    span.style.fontWeight = 'bold';
                }
            }
            
            // --- Le reste du script est fonctionnel et recopié ---
            function generateAdherentFields(count) {
                adherentInfoContainer.innerHTML = '';
                photoFilesMap.clear();
                const type = document.querySelector('input[name="typeAdherent"]:checked')?.value;
                for (let i = 1; i <= count; i++) {
                    const isMajeur = type === 'majeur';
                    const title = isMajeur ? `<h4>Informations Adhérent</h4>` : `<h4>Informations Enfant ${i}</h4>`;
                    const fieldGroup = document.createElement('div');
                    fieldGroup.className = 'child-info-group';
                    fieldGroup.innerHTML = `
                        ${title}
                        <input type="text" name="prenom_${i}" placeholder="Prénom" required>
                        <input type="text" name="nom_${i}" placeholder="Nom" required>
                        <label for="dateNaissance_${i}">Date de naissance :</label>
                        <input type="date" id="dateNaissance_${i}" name="dateNaissance_${i}" required>
                        ${isMajeur ? `<input type="email" name="email_${i}" placeholder="Email (pour confirmation)" required><input type="text" name="adresse_${i}" placeholder="Adresse postale" required><input type="text" name="codePostal_${i}" placeholder="Code Postal" required><input type="text" name="ville_${i}" placeholder="Ville" required>` : ''}
                        <div class="file-upload-wrapper">
                            <p style="margin-bottom: 10px;">Photo d'identité :</p>
                            <small style="display:block; margin: -5px 0 10px 0;">Placez le visage dans le cadre sur un fond clair.</small>
                            <button type="button" class="btn choose-photo-btn" data-child-index="${i}">Choisir un fichier</button>
                            <button type="button" class="btn take-photo-btn" data-child-index="${i}">Prendre une photo</button>
                            <span id="photo-file-name-${i}">Aucune photo choisie</span>
                        </div>
                    `;
                    adherentInfoContainer.appendChild(fieldGroup);
                }
            }
            const getAdherentCount = () => { const type = document.querySelector('input[name="typeAdherent"]:checked')?.value; return type === 'majeur' ? 1 : parseInt(numEnfantsSelect.value, 10); };
            document.querySelectorAll('input[name="reponseQuestionnaire"]').forEach(radio => radio.addEventListener('change', (e) => { const certifContainer = document.getElementById('certificat-medical-container'); const certifInput = document.getElementById('certificatMedical'); const signatureInfo = document.getElementById('email-signature-info'); if (e.target.value === 'oui') { certifContainer.classList.remove('hidden'); certifInput.required = true; signatureInfo.classList.add('hidden'); } else { certifContainer.classList.add('hidden'); certifInput.required = false; signatureInfo.classList.remove('hidden'); }}));
            function updateCotisation() { const type = document.querySelector('input[name="typeAdherent"]:checked')?.value; let montant = 130; if (type === 'mineur') { const nbEnfants = parseInt(numEnfantsSelect.value); const tarifs = { 1: 130, 2: 210, 3: 230, 4: 250 }; montant = tarifs[nbEnfants] || 250; } document.getElementById('montantTotal').textContent = `${montant} €`; }
            document.getElementById('certificatMedical').addEventListener('change', (e) => { document.getElementById('certificat-file-name').textContent = e.target.files.length > 0 ? `${e.target.files.length} fichier(s) choisi(s)` : "Aucun fichier choisi"; });
            form.addEventListener('submit', async (e) => { e.preventDefault(); document.getElementById('loading').classList.remove('hidden'); form.classList.add('hidden'); try { const formData = new FormData(form); const adherentCount = getAdherentCount(); const orderedPhotoFiles = []; for (let i = 1; i <= adherentCount; i++) { orderedPhotoFiles.push(photoFilesMap.get(String(i))); } const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve({ base64: reader.result, mimeType: file.type, fileName: file.name }); reader.onerror = reject; }); const photosBase64 = await Promise.all(orderedPhotoFiles.map(f => fileToBase64(f))); const data = { typeAdherent: formData.get('typeAdherent'), nomResponsable: formData.get('nomResponsable'), emailResponsable: formData.get('emailResponsable'), telephoneResponsable: formData.get('telephoneResponsable'), adresseResponsable: formData.get('adresseResponsable'), codePostalResponsable: formData.get('codePostalResponsable'), villeResponsable: formData.get('villeResponsable'), montantCotisation: document.getElementById('montantTotal').textContent, reponseSante: formData.get('reponseQuestionnaire'), droitImageAccepte: formData.get('droitImage') === 'on', reglementAccepte: formData.get('reglement') === 'on', adherents: [], photos: photosBase64, certificats: await Promise.all(Array.from(formData.getAll('certificatMedical')).filter(f => f.size > 0).map(f => fileToBase64(f))) }; for (let i = 1; i <= adherentCount; i++) { data.adherents.push({ prenom: formData.get(`prenom_${i}`), nom: formData.get(`nom_${i}`), dateNaissance: formData.get(`dateNaissance_${i}`), email: formData.get(`email_${i}`), adresse: formData.get(`adresse_${i}`), codePostal: formData.get(`codePostal_${i}`), ville: formData.get(`ville_${i}`), }); } const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }); const result = await response.json(); document.getElementById('loading').classList.add('hidden'); if (result.status === 'success') { document.getElementById('montantFinal').textContent = data.montantCotisation; document.getElementById('successMessage').classList.remove('hidden'); } else { throw new Error(result.message); } } catch (error) { console.error('Erreur:', error); document.getElementById('loading').classList.add('hidden'); document.getElementById('errorMessage').classList.remove('hidden'); } });
        });
    </script>
</body>
</html>
