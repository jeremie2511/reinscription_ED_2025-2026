<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réinscription - Espérance Drouaise</title>
    
    <!-- ======================= CSS INTÉGRÉ ======================= -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root { /* ... (CSS inchangé) ... */ }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light-grey); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .form-container { max-width: 600px; width: 100%; background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); overflow: hidden; }
        header { text-align: center; margin-bottom: 25px; }
        .logo { max-width: 80px; margin-bottom: 10px; }
        h2 { color: #005a9c; margin: 0; }
        h3, h4 { color: #333; }
        h4 { margin-top: 20px; border-bottom: 2px solid #f4f7f6; padding-bottom: 5px; }
        .progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 30px; height: 10px; margin-bottom: 30px; }
        .progress-bar-fill { height: 100%; background-color: #28a745; border-radius: 30px; width: 0%; transition: width 0.4s ease-in-out; }
        #inscriptionForm { position: relative; min-height: 400px; }
        .form-step { position: absolute; width: 100%; opacity: 0; transition: all 0.3s ease-in-out; transform: translateX(100%); pointer-events: none; }
        .form-step.active { position: relative; opacity: 1; transform: translateX(0); pointer-events: auto; }
        .form-step.inactive-prev { transform: translateX(-100%); }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; font-size: 1rem; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .radio-card-group { display: flex; gap: 15px; }
        .radio-card { flex: 1; background: #f9f9f9; border: 2px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .radio-card input[type="radio"] { display: none; }
        .radio-card:has(input:checked) { border-color: #28a745; box-shadow: 0 0 10px rgba(40, 167, 69, 0.2); }
        .radio-card input[type="radio"]:checked + span { color: #28a745; font-weight: 600; }
        .radio-group-vertical label { display: block; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; cursor: pointer; }
        .checkbox-group { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .btn-next, #submitBtn { background-color: #28a745; color: white; }
        .btn-prev { background-color: #ccc; }
        .file-upload-wrapper { margin-top: 15px; text-align: center; }
        .file-upload-wrapper input[type="file"] { display: none; }
        .file-upload-wrapper .btn { display: inline-block; background-color: #6c757d; color: white; margin: 5px; font-size: 0.9rem; padding: 10px 15px; }
        .file-upload-wrapper span { display: block; margin-top: 10px; color: #555; font-style: italic; }
        .hidden { display: none !important; }
        .warning { background-color: #fff3cd; color: #856404; padding: 15px; border: 1px solid #ffeeba; border-radius: 5px; margin: 15px 0; }
        #loading, #successMessage, #errorMessage { text-align: center; padding: 40px 20px; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #005a9c; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .child-info-group { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #fafafa; }
        .health-pdf-links a { display: block; text-align: center; padding: 10px; background-color: #005a9c; color: white; text-decoration: none; border-radius: 8px; margin-bottom: 10px; }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div class="form-container">
        <header>
            <img src="https://i.imgur.com/lnozkwr.png" alt="Logo Espérance Drouaise" class="logo">
            <h2>Réinscription Saison 2025-2026</h2>
        </header>

        <!-- MODIFICATION : Moins d'étapes, la barre de progression est ajustée -->
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        
        <!-- Un seul input file caché pour tout le formulaire -->
        <input type="file" id="photo-file-input" class="hidden" accept="image/*">

        <form id="inscriptionForm">
            <!-- ÉTAPE 1: TYPE D'ADHÉRENT ET NOMBRE D'ENFANTS -->
            <div class="form-step active" data-step="1">
                <h3>Pour qui est cette réinscription ?</h3>
                <div class="radio-card-group">
                    <label class="radio-card"><input type="radio" name="typeAdherent" value="mineur" required><span>Un ou plusieurs mineurs</span></label>
                    <label class="radio-card"><input type="radio" name="typeAdherent" value="majeur" required><span>Un adhérent majeur</span></label>
                </div>
                <div id="cotisation-mineur-select" class="hidden">
                    <p>Combien d'enfants de la famille inscrivez-vous ?</p>
                    <select id="numEnfants" name="numEnfants">
                        <option value="1">1 enfant</option><option value="2">2 enfants</option>
                        <option value="3">3 enfants</option><option value="4">4+ enfants</option>
                    </select>
                </div>
                <button type="button" class="btn btn-next">Suivant</button>
            </div>

            <!-- ÉTAPE 2: INFORMATIONS PERSONNELLES ET PHOTOS -->
            <div class="form-step" data-step="2">
                <h3>Informations personnelles</h3>
                <div id="section-responsable" class="hidden">
                    <h4>Responsable Légal</h4>
                    <input type="text" name="nomResponsable" placeholder="Nom & Prénom du responsable" required>
                    <input type="email" name="emailResponsable" placeholder="Email (pour la confirmation)" required>
                    <input type="tel" name="telephoneResponsable" placeholder="Téléphone" required>
                    <input type="text" name="adresseResponsable" placeholder="Adresse postale" required>
                    <input type="text" name="codePostalResponsable" placeholder="Code Postal" required>
                    <input type="text" name="villeResponsable" placeholder="Ville" required>
                </div>
                <div id="adherent-info-container"></div>
                <div class="nav-buttons">
                    <button type="button" class="btn btn-prev">Précédent</button>
                    <button type="button" class="btn btn-next">Suivant</button>
                </div>
            </div>
            
            <!-- ÉTAPE 3: SANTÉ -->
            <div class="form-step" data-step="3">
                <h3>Dossier de Santé</h3>
                <div class="health-pdf-links">
                    <a href="https://drive.google.com/file/d/1dD8kER0IXqTzQwUT9EEfKdsBb13-Qv9p/view?usp=share_link" target="_blank" rel="noopener noreferrer">Consulter le questionnaire MINEUR</a>
                    <a href="https://drive.google.com/file/d/1g343Xgj3jVNfLD31uHyXyT-l2a048RwS/view?usp=sharing" target="_blank" rel="noopener noreferrer">Consulter le questionnaire MAJEUR</a>
                </div>
                <div class="radio-group-vertical" style="margin-top:20px;">
                    <label><input type="radio" name="reponseQuestionnaire" value="non" required> J'atteste avoir répondu "NON" à toutes les questions.</label>
                    <small id="email-signature-info" class="hidden" style="display:block;margin-top:-5px;margin-bottom:10px;padding-left:15px;color:#555;">Un e-mail vous sera envoyé pour signer électroniquement cette attestation.</small>
                    <label><input type="radio" name="reponseQuestionnaire" value="oui" required> J'ai répondu "OUI" à au moins une question (certificat médical requis).</label>
                </div>
                <div id="certificat-medical-container" class="hidden file-upload-wrapper">
                    <p class="warning">Veuillez joindre un certificat médical pour chaque personne concernée.</p>
                    <label for="certificatMedical" class="btn">Téléverser le(s) certificat(s)</label>
                    <input type="file" id="certificatMedical" name="certificatMedical" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                    <span id="certificat-file-name">Aucun fichier choisi</span>
                </div>
                <div class="nav-buttons">
                    <button type="button" class="btn btn-prev">Précédent</button>
                    <button type="button" class="btn btn-next">Suivant</button>
                </div>
            </div>

            <!-- ÉTAPE 4: FINALISATION ET COTISATION -->
            <div class="form-step" data-step="4">
                <h3>Finalisation</h3>
                 <div id="section-cotisation">
                     <h4>Cotisation</h4>
                     <p>Montant total pour la saison : <strong id="montantTotal">130 €</strong></p>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="droitImage" name="droitImage" required>
                    <label for="droitImage">J'autorise la prise de vue et la diffusion de mon image (ou celle de mon/mes enfant(s)).</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="reglement" name="reglement" required>
                    <label for="reglement">J'ai lu et j'accepte le <a href="https://drive.google.com/file/d/1sBCrjrDXDr-Qh1mcUJ71ytZFIiTt5xvi/view?usp=sharing" target="_blank" rel="noopener noreferrer">règlement intérieur</a>.</label>
                </div>
                <div class="nav-buttons">
                    <button type="button" class="btn btn-prev">Précédent</button>
                    <button type="submit" id="submitBtn" class="btn">Envoyer la pré-inscription</button>
                </div>
            </div>
        </form>

        <div id="loading" class="hidden">...</div>
        <div id="successMessage" class="hidden">...</div>
        <div id="errorMessage" class="hidden">...</div>
    </div>
    
    <div id="camera-modal" class="hidden">...</div>

    <!-- ======================= JAVASCRIPT CORRIGÉ ======================= -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzoDe8VcbxozPLjZTDsh8qs83P-ch6fMmKKz4L01qfy9adk6fjVBWp6boyGWQab7kMVTA/exec';
            
            // ... (Déclaration des constantes)
            const form = document.getElementById('inscriptionForm');
            const steps = Array.from(document.querySelectorAll('.form-step'));
            const nextBtns = document.querySelectorAll('.btn-next');
            const prevBtns = document.querySelectorAll('.btn-prev');
            const progressBar = document.getElementById('progressBar');
            const sectionResponsable = document.getElementById('section-responsable');
            const typeAdherentRadios = document.querySelectorAll('input[name="typeAdherent"]');
            const adherentInfoContainer = document.getElementById('adherent-info-container');
            const numEnfantsSelect = document.getElementById('numEnfants');
            const cotisationMineurSelect = document.getElementById('cotisation-mineur-select');
            const reponseQuestionnaireRadios = document.querySelectorAll('input[name="reponseQuestionnaire"]');
            const certificatContainer = document.getElementById('certificat-medical-container');
            const certificatInput = document.getElementById('certificatMedical');
            
            let currentStep = 1;
            let photoFilesMap = new Map(); // MODIFICATION : On utilise une Map pour lier photo et enfant
            let currentlyActiveChildIndex = null; // Pour savoir pour quel enfant on gère une photo

            // --- GESTION PHOTO (MAJEURE) ---
            const hiddenPhotoInput = document.getElementById('photo-file-input');
            const cameraModal = document.getElementById('camera-modal');
            
            adherentInfoContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('choose-photo-btn')) {
                    currentlyActiveChildIndex = target.dataset.childIndex;
                    hiddenPhotoInput.click(); // Déclenche l'input file caché
                }
                if (target.classList.contains('take-photo-btn')) {
                    currentlyActiveChildIndex = target.dataset.childIndex;
                    // ... (logique d'ouverture de la caméra)
                }
            });
            
            hiddenPhotoInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0 && currentlyActiveChildIndex) {
                    photoFilesMap.set(currentlyActiveChildIndex, e.target.files[0]);
                    updatePhotoFileName(currentlyActiveChildIndex, e.target.files[0].name);
                }
                hiddenPhotoInput.value = ''; // Réinitialiser pour pouvoir sélectionner le même fichier à nouveau
            });

            function updatePhotoFileName(childIndex, fileName) {
                const span = document.getElementById(`photo-file-name-${childIndex}`);
                if (span) {
                    span.textContent = fileName;
                    span.style.color = '#28a745';
                    span.style.fontWeight = 'bold';
                }
            }

            // --- GESTION FORMULAIRE ---
            nextBtns.forEach(btn => btn.addEventListener('click', () => { if (validateStep(currentStep)) changeStep('next'); }));
            prevBtns.forEach(btn => btn.addEventListener('click', () => changeStep('prev')));
            function changeStep(dir) { /* ... (inchangé) ... */ }
            function updateProgressBar() { progressBar.style.width = `${((currentStep - 1) / (steps.length - 1)) * 100}%`; }

            function validateStep(step) {
                const currentStepElement = document.querySelector(`.form-step[data-step="${step}"]`);
                const inputs = currentStepElement.querySelectorAll('input[required], select[required]');
                for (const input of inputs) { if (!input.value && input.type !== 'radio' && input.type !== 'checkbox') { alert('Veuillez remplir tous les champs.'); return false; } if ((input.type === 'radio' || input.type === 'checkbox') && !document.querySelector(`input[name="${input.name}"]:checked`)) { alert('Veuillez faire un choix.'); return false; } }
                
                if (step === 2) {
                    const adherentCount = getAdherentCount();
                    for (let i = 1; i <= adherentCount; i++) {
                        if (!photoFilesMap.has(String(i))) {
                            alert(`Veuillez fournir une photo d'identité pour l'adhérent n°${i}.`);
                            return false;
                        }
                    }
                }
                return true;
            }

            // Génère les champs pour chaque enfant, y compris les boutons de photo
            function generateAdherentFields(count) {
                adherentInfoContainer.innerHTML = '';
                const type = document.querySelector('input[name="typeAdherent"]:checked')?.value;
                for (let i = 1; i <= count; i++) {
                    const isMajeur = type === 'majeur';
                    const title = isMajeur ? `<h4>Informations Adhérent</h4>` : `<h4>Informations Enfant ${i}</h4>`;
                    const fieldGroup = document.createElement('div');
                    fieldGroup.className = 'child-info-group';
                    fieldGroup.innerHTML = `
                        ${title}
                        <input type="text" name="prenom_${i}" placeholder="Prénom" required>
                        <input type="text" name="nom_${i}" placeholder="Nom" required>
                        <label for="dateNaissance_${i}">Date de naissance :</label>
                        <input type="date" id="dateNaissance_${i}" name="dateNaissance_${i}" required>
                        ${isMajeur ? `<input type="email" name="email_${i}" placeholder="Email (pour confirmation)" required> ... (autres champs majeurs)` : ''}
                        
                        <div class="file-upload-wrapper">
                            <p>Photo d'identité :</p>
                            <button type="button" class="btn choose-photo-btn" data-child-index="${i}">Choisir un fichier</button>
                            <button type="button" class="btn take-photo-btn" data-child-index="${i}">Prendre une photo</button>
                            <span id="photo-file-name-${i}">Aucune photo choisie</span>
                        </div>
                    `;
                    adherentInfoContainer.appendChild(fieldGroup);
                }
            }
            
            // ... (logique de typeAdherent, cotisation, etc. inchangée mais simplifiée)
            typeAdherentRadios.forEach(radio => radio.addEventListener('change', () => { /* ... */ }));
            numEnfantsSelect.addEventListener('change', () => { /* ... */ });

            // ... (logique de soumission)
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                // ... (affichage du loading)
                
                // NOUVEAU : Construire le tableau de photos dans le bon ordre
                const orderedPhotoFiles = [];
                const adherentCount = getAdherentCount();
                for (let i = 1; i <= adherentCount; i++) {
                    orderedPhotoFiles.push(photoFilesMap.get(String(i)));
                }
                
                // Convertir `orderedPhotoFiles` en base64
                data.photos = await Promise.all(orderedPhotoFiles.map(f => fileToBase64(f)));

                // ... (le reste de la soumission `fetch` reste identique)
            });

            // ... (Autres fonctions utilitaires: getAdherentCount, fileToBase64, etc.)
        });
    </script>
</body>
</html>
